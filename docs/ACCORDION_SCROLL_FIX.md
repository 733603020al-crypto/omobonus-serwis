# Исправление прокрутки аккордеона для подкатегорий

## Проблемы

1. При открытии подкатегории в секции "Naprawy i usługi serwisowe (opcjonalne)" её заголовок не поднимался под заголовок секции, что приводило к потере контекста для пользователя.

2. При закрытии подкатегории страница "прыгала" вниз, возвращаясь к старой позиции прокрутки, что создавало нежелательный визуальный эффект.

## Решения

### 1. Открытие подкатегории

Реализована функция `scrollSubcategoryToTop`, которая:
1. Прокручивает страницу так, чтобы заголовок секции был виден с отступом `SECTION_SCROLL_OFFSET` (120px)
2. Находит scrollable контейнер внутри `AccordionContent` (элемент с `overflow-y-auto`)
3. Прокручивает этот контейнер так, чтобы заголовок открытой подкатегории был в самом верху контейнера

### 2. Закрытие подкатегории

Реализована агрессивная логика предотвращения прокрутки при закрытии:
1. **Сохранение позиции ДО изменения состояния**: При закрытии подкатегории позиция прокрутки сохраняется в `handleSubcategoryChange` ДО вызова `setOpenSubcategory`, чтобы зафиксировать позицию до начала анимации и пересчета layout браузером
2. **Активное поддержание позиции**: Во время анимации закрытия (~350ms) запускается интервал (каждые 16ms), который постоянно поддерживает сохраненную позицию прокрутки страницы и контейнера, предотвращая автоматическую корректировку браузером
3. **Финальное восстановление**: После завершения анимации позиция финально восстанавливается один раз
4. **Мгновенное восстановление**: Используется `behavior: 'auto'` для мгновенного восстановления без плавной прокрутки - никаких `behavior: 'smooth'` при закрытии
5. **Результат**: Заголовок подкатегории остается на месте экрана, контент просто плавно сворачивается под ним, страница не двигается

## Изменения

### 1. Новые refs для отслеживания состояния

```typescript
const prevOpenSubcategoryRef = useRef<string | null>(null)
const scrollPositionOnCloseRef = useRef<{ pageScroll: number; containerScroll: number } | null>(null)
```

**Назначение:**
- `prevOpenSubcategoryRef` - отслеживает предыдущее значение `openSubcategory` для определения момента закрытия
- `scrollPositionOnCloseRef` - сохраняет позиции прокрутки при закрытии для последующего восстановления

### 2. Функция `scrollSubcategoryToTop`

Расположена в `src/app/uslugi/service-accordion.tsx` (строка ~1210)

**Особенности:**
- Использует двойной `requestAnimationFrame` + задержку для ожидания завершения анимации Radix UI Accordion
- Находит `AccordionTrigger` внутри `AccordionItem` подкатегории для прокрутки к заголовку
- Находит scrollable контейнер через проверку computed styles (`overflow-y: auto/scroll` или `max-height`)
- Последовательно прокручивает сначала страницу, затем контейнер (с учетом задержки)

### 3. Обновлен `useEffect` для подкатегорий

```typescript
useEffect(() => {
  if (!openSubcategory || openSection !== 'naprawy') return
  
  const sectionRef = sectionRefs.current['naprawy']
  const subcategoryRef = subcategoryRefs.current[openSubcategory]
  
  if (!sectionRef || !subcategoryRef) return

  // Прокручиваем подкатегорию к верху внутри контейнера
  scrollSubcategoryToTop(sectionRef, subcategoryRef, SECTION_SCROLL_OFFSET)
}, [openSubcategory, openSection])
```

**Добавлено:**
- Функция `findScrollableContainer` для переиспользования логики поиска scrollable контейнера
- Сохранение позиции прокрутки в `handleSubcategoryChange` ДО изменения состояния (`setOpenSubcategory`)
- Активное поддержание позиции прокрутки через `setInterval` (каждые 16ms) во время анимации закрытия
- Ref `scrollLockIntervalRef` для отслеживания и очистки активного интервала
- Cleanup интервала при размонтировании или изменении зависимостей
- Очистка всех состояний при открытии подкатегории или закрытии секции

**Удалено:**
- Блокирующая проверка `if (rect.bottom > 70) return`
- Прокрутка только родительской секции вместо подкатегории

## Поведение

### При открытии подкатегории:
1. ✅ Заголовок подкатегории автоматически поднимается под заголовок секции
2. ✅ Прокрутка плавная и предсказуемая
3. ✅ При открытии нового подблока он сам поднимается, ранее открытый сворачивается (через `type="single"` в Accordion)

### При закрытии подкатегории:
1. ✅ Страница не "прыгает" вниз - позиция прокрутки сохраняется
2. ✅ Заголовок подкатегории остается на месте экрана
3. ✅ Контент плавно сворачивается под заголовком без скачков
4. ✅ Нет лишних анимаций прокрутки или визуальных артефактов

### Общее:
1. ✅ Правильно обрабатывается вложенный скролл (контейнер с `overflow-y-auto`)
2. ✅ Логика не блокирует прокрутку в нужных случаях
3. ✅ Работает одинаково на десктопе и мобильных устройствах

## Технические детали

### Поиск scrollable контейнера

Функция ищет элемент с `overflow-y: auto` или `scroll` в следующем порядке:
1. Дочерние элементы `AccordionContent` (внутренний div с className)
2. Сам `AccordionContent` (если у него есть overflow)
3. Fallback: первый дочерний div или сам `AccordionContent`

### Тайминги

**При открытии:**
- Задержка после RAF: 100ms (для завершения анимации раскрытия Radix UI)
- Задержка перед прокруткой контейнера (если была прокрутка страницы): 200ms

**При закрытии:**
- Сохранение позиции: синхронно в `handleSubcategoryChange` ДО изменения состояния
- Активное поддержание: `setInterval` каждые 16ms (60 FPS) в течение ~350ms анимации
- Финальное восстановление: через 350ms после начала закрытия (больше времени анимации Radix UI ~200-300ms)
- Порог восстановления: позиция поддерживается если отклонение больше 1px (для предотвращения микро-скачков)

### Отступы

- Отступ сверху страницы: `SECTION_SCROLL_OFFSET` (120px)
- Отступ сверху в контейнере: 10px (для визуального комфорта)

## Совместимость

- ✅ Работает на всех страницах с секцией "naprawy"
- ✅ Десктоп и мобильные устройства
- ✅ Учитывает структуру DOM Radix UI Accordion

